# BlueBubbles migration progress

This roadmap tracks the BlueBubbles transport work that landed after the fork. Pull request numbers match the upstream GitHub IDs; missing numbers were not merged into this branch.

## Completed pull requests since fork
1. **PR #1 – Remove Firebase and Google integrations**: Introduced a BlueBubbles-centric onboarding form and sign-in gate that validate server credentials, persist sessions securely, and feed the messaging UI. 【F:src/components/Onboarding.tsx†L1-L165】【F:src/components/SignInGate.tsx†L1-L260】
2. **PR #2 – Implement BlueBubbles communications manager**: Added the REST transport, connection lifecycle wiring, and event emitters that hydrate chats, threads, and updates from BlueBubbles servers. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L1-L210】【F:src/connection/connectionManager.ts†L1-L120】
3. **PR #3 – Add the migration roadmap**: Published this living roadmap so contributors can understand the BlueBubbles state of play. 【F:project.md†L1-L200】
4. **PR #4 – Refresh contributor documentation**: Updated the README to highlight the migration plan, cloning steps, and environment-based Sentry configuration. 【F:README.md†L1-L64】
5. **PR #5 – Fix invalid host header errors**: Configured the webpack dev server to bind to `0.0.0.0` and accept forwarded hosts, unblocking remote development. 【F:webpack.config.js†L10-L26】
6. **PR #6 – Refactor secure storage for crypto fallbacks**: Hardened secure storage helpers to detect browser crypto support, fall back gracefully, and expose BlueBubbles credential keys. 【F:src/util/secureStorageUtils.ts†L1-L187】
7. **PR #7 – Remove legacy tracking scripts**: Simplified the HTML shell so it only loads the compiled bundle, eliminating the deprecated analytics tag. 【F:public/index.html†L1-L26】
8. **PR #8 – Refactor Sentry integration and secrets**: Loaded Sentry settings from build-time environment variables and documented the opt-in workflow. 【F:src/index.tsx†L1-L44】【F:README.md†L33-L64】
9. **PR #9 – Extend BlueBubbles auth for legacy servers**: Added password-based probing and metadata so clients can authenticate against legacy BlueBubbles deployments. 【F:src/util/bluebubblesAuth.ts†L121-L218】
10. **PR #10 – Investigate BlueBubbles login errors**: Improved token refresh, error handling, and persistence logic in the sign-in gate to recover from mismatched auth flows. 【F:src/components/SignInGate.tsx†L52-L215】
11. **PR #11 – Adjust message ordering in the BlueBubbles communications manager**: Normalized thread fetches and polling so message updates arrive in newest-first order. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L333-L412】
12. **PR #12 – Fix duplicate message handling**: Normalized BlueBubbles GUIDs, cached tapbacks, and filtered duplicates when hydrating message batches. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L454-L610】
13. **PR #13 – Investigate notification sound issues**: Guarded conversation preview lookups, unread state, and notification playback to avoid redundant alerts. 【F:src/state/conversationState.ts†L96-L320】
14. **PR #14 – Remove unused update-related code**: Simplified the connection error dialog to focus on recovery and reconfiguration instead of the old update prompts. 【F:src/components/messaging/detail/DetailError.tsx†L1-L180】
15. **PR #17 – Add settings item to the menu icon**: Exposed the settings dialog in the sidebar overflow menu so users can tweak local preferences. 【F:src/components/messaging/master/Sidebar.tsx†L54-L205】
16. **PR #18 – Optimize message fetching and rendering**: Reworked conversation state bookkeeping to merge new items efficiently, update previews, and manage unread badges. 【F:src/state/conversationState.ts†L96-L320】
17. **PR #22 – Add initial load count for conversation settings**: Persisted the conversation chunk size in settings and surfaced a UI to tune lazy loading. 【F:src/components/settings/SettingsProvider.tsx†L1-L171】【F:src/components/messaging/dialog/SettingsDialog.tsx†L26-L142】
18. **PR #23 – Optimize MessageList rendering**: Added targeted `shouldComponentUpdate` guards and scroll snapshots to the thread list to reduce unnecessary renders. 【F:src/components/messaging/thread/MessageList.tsx†L25-L193】
19. **PR #25 – Add instrumentation and extend tapback parsing**: Introduced BlueBubbles debug logging and richer reaction mapping to diagnose tapback payloads. 【F:src/connection/bluebubbles/debugLogging.ts†L1-L20】【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L454-L505】
20. **PR #26 – Add hover information for tapback sender**: Displayed sender tooltips on tapback chips to clarify who reacted. 【F:src/components/messaging/thread/item/bubble/TapbackChip.tsx†L17-L78】
21. **PR #28 – Add message service helpers and extend processing**: Detected SMS transports, parsed wrapped tapbacks, and hardened attachment downloads in the BlueBubbles transport. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L454-L686】
22. **PR #29 – Augment bootstrap flow for conversation prefetching**: Prefetched conversation lists after connection and manual loads to keep the sidebar populated. 【F:src/state/conversationState.ts†L469-L538】
23. **PR #30 – Add debug setting for console messages**: Added a developer toggle that enables or silences BlueBubbles debug logging while persisting the choice locally. 【F:src/components/settings/SettingsProvider.tsx†L1-L171】【F:src/components/messaging/dialog/SettingsDialog.tsx†L42-L142】
24. **PR #31 – Add message search functionality to BlueBubbles**: Wired the REST `/message/query` endpoint into the connection manager and message-search hook with SQL escaping and user-facing errors. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L134-L205】【F:src/connection/connectionManager.ts†L646-L671】【F:src/state/useMessageSearch.ts†L1-L112】
25. **PR #32 – Add sidebar message search UI**: Added a toolbar toggle, dedicated search panel, and result list that ties into the debounced hook so users can filter by time range and jump to matching threads. 【F:src/components/messaging/master/Sidebar.tsx†L55-L372】【F:src/components/messaging/master/Messaging.tsx†L41-L113】
26. **PR #33 – Hide link preview payload attachments**: Filtered hidden BlueBubbles attachments so plugin payload blobs no longer surface as downloadable files in threads or previews. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L575-L614】【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L817-L827】
27. **PR #34 – Publish address book manifest templates**: Added tracked and local-only manifest files so contributors can describe address book sources with IDs, human-readable labels, formats, and versioning metadata that map to CSV samples under `public/address-books/`. 【F:public/address-books/manifest.json†L1-L19】【F:public/address-books/manifest.example.json†L1-L17】
28. **PR #35 – Implement CSV parsers with validation**: Introduced Google and Baikal CSV parsers plus regression tests that normalize phone/email data, honor label columns, and skip invalid rows before emitting contact records. 【F:src/interface/people/addressBookParsers.ts†L1-L347】【F:src/interface/people/__tests__/addressBookParsers.test.ts†L1-L180】
29. **PR #36 – Overhaul PeopleContext for manifest-driven sync**: Rebuilt the people provider to load the manifest, respect settings overrides, stream per-source sync progress, merge and deduplicate contacts across sources, and cache results with version-aware invalidation. 【F:src/state/peopleState.tsx†L107-L396】【F:src/state/peopleState.tsx†L520-L851】
30. **PR #37 – Persist address book preferences in settings**: Extended the settings store to sanitize enabled source lists, round-trip them through local storage, and expose helper tests that guarantee updates remain idempotent. 【F:src/components/settings/SettingsProvider.tsx†L9-L218】【F:test/components/settings/SettingsProvider.test.tsx†L1-L78】
31. **PR #38 – Wire providers and settings UI**: Nested the `PeopleContextProvider` inside the global settings provider and expanded the settings dialog so users can toggle sources, trigger syncs, inspect errors, and clear cached contact data. 【F:src/index.tsx†L1-L47】【F:src/components/messaging/dialog/SettingsDialog.tsx†L210-L313】
32. **PR #39 – Surface iMessage read receipts in one-on-one chats**: Trusted BlueBubbles `dateDelivered`/`dateRead` timestamps, rendered the latest outgoing iMessage receipt when the conversation only includes a single remote participant, and now ignore server capability flags when explicit timestamps arrive so read states still appear. 【F:src/components/messaging/thread/MessageList.tsx†L74-L111】【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L1269-L1295】

## Outstanding integration gaps
- **Live updates**: The REST transport still polls every five seconds; we should evaluate push channels or server-sent events to deliver updates instantly. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L333-L364】 [codex](https://chatgpt.com/codex/tasks/task_e_69119d4f1370832da7a7efc6990ccb18)
  - **Webhook relay on Cloud Run**: Build a lightweight Node service (or containerized equivalent) that exposes a public HTTPS webhook endpoint for BlueBubbles, validates shared secrets, and keeps per-client Server-Sent Event or WebSocket streams open. The relay should persist the last processed timestamp (Firestore, Cloud Storage, or in-memory with periodic checkpoints) so it can replay missed messages via `/message/query` on restart.
  - **Firebase Cloud Functions option**: For teams preferring serverless infrastructure, author an HTTP-triggered function that receives BlueBubbles webhooks, authenticates them, and fan-outs updates either directly via SSE (supported in 2nd gen functions) or by publishing to Firebase Cloud Messaging / Firestore where the browser subscribes to real-time listeners. Document trade-offs around latency and operational cost compared with Cloud Run.
  - **Client subscription path**: Extend `BlueBubblesCommunicationsManager` to connect to the relay channel when available, stream message/modifier payloads into the existing listener callbacks, and fall back to the current polling loop if the push transport fails. Capture this flow in onboarding documentation once the relay is available.
- **People data and contact permissions (in progress)**: The app now hydrates contacts from manifest-defined CSV sources, respects per-source toggles, and surfaces sync status/errors in settings, but still lacks an authenticated pipeline for BlueBubbles-hosted address books and permission prompts. Follow-ups include fetching server-backed contacts, honoring transport-provided avatars, and reconciling contacts for members without manifest entries. 【F:src/state/peopleState.tsx†L134-L396】【F:src/components/messaging/dialog/SettingsDialog.tsx†L210-L313】
- **Conversation bootstrap for ad-hoc chats**: Creating new chats relies on cached GUIDs because the transport cannot yet resolve unlinked conversations on demand. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L432-L452】
- **Retrieval API parity**: Time/ID-based history retrieval is still stubbed because the REST API lacks equivalent endpoints, limiting recovery for deep history. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L385-L410】

## Future enhancements
- **Typing indicators and presence**: The server advertises typing indicator support, but the client does not subscribe or render those events yet. 【F:src/connection/bluebubbles/types.ts†L1-L24】
- **Broader delivery state feedback**: Extend the new one-on-one iMessage read receipts to group chats and additional services once BlueBubbles exposes reliable timestamps. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L320-L370】
- **Attachment lifecycle polish**: Attachment uploads and downloads still rely on polling, and we could expose better progress/status feedback. 【F:src/connection/bluebubbles/bluebubblesCommunicationsManager.ts†L414-L610】
- **Advanced message search UX**: Build on the new sidebar search panel by surfacing pagination controls and richer filtering powered by the hook metadata. 【F:src/state/useMessageSearch.ts†L1-L112】【F:src/components/messaging/master/Sidebar.tsx†L287-L372】
- **Address book sync polish**: Add BlueBubbles-side contact ingestion, configurable source priorities for deduplication, and size-aware caching strategies (e.g., IndexedDB fallback) to support larger directories without exhausting localStorage. 【F:src/state/peopleState.tsx†L520-L851】

## Address book assets
- Static address-book uploads live under `public/address-books/`. Each CSV must follow the filename pattern `addressbook.<id>.<type>.csv` so the `<id>` aligns with its manifest entry and `<type>` communicates the data category (for example, `personal`, `work`, or `vip`).
- The manifest files (`manifest.example.json` and local `manifest.json`) now declare each source’s `format`, optional `version`, and default enabled state so the sync layer can choose a parser, detect updates, and seed UI defaults. Keep the tracked example in sync with any schema changes. 【F:public/address-books/manifest.json†L1-L19】【F:src/state/peopleState.tsx†L399-L510】
- PeopleContext sanitizes manifest entries, normalizes merged contacts, and caches per-source results in `localStorage` with version-aware invalidation—avoid oversized CSVs that could breach storage quotas or slow initial load. 【F:src/state/peopleState.tsx†L134-L396】【F:src/state/peopleState.tsx†L520-L777】
- Keep sample CSVs lightweight. Headers should match the downstream importer expectations (e.g., `first_name,last_name,phone,email`) and rows should avoid real customer data.
-
## Media drawer feature
- Added a thread-level media drawer that exposes a grid of recent attachments via `ConversationMediaDrawer`, wired into the `DetailFrame` chrome so BlueBubbles-authenticated conversations can browse media without leaving the thread view. 【F:src/components/messaging/thread/DetailThread.tsx†L692-L748】【F:src/components/messaging/thread/ConversationMediaDrawer.tsx†L103-L210】
- The drawer relies on the BlueBubbles REST transport: `useConversationMedia` rejects other proxies and unsynced conversations, while attachment previews stream through `ConnectionManager.fetchAttachment`. 【F:src/state/useConversationMedia.ts†L110-L214】【F:src/components/messaging/thread/ConversationMediaDrawer.tsx†L172-L205】
- Follow-ups: implement transport-agnostic media retrieval, handle local-only conversations, and consider richer preview states (progress, failure recovery) as hinted by current snackbar-based error paths. 【F:src/state/useConversationMedia.ts†L127-L214】【F:src/components/messaging/thread/ConversationMediaDrawer.tsx†L162-L210】
